---
- name: Setup NFS
  command: "{{ item }}"
  with_items:
  - mkdir /nfs-share
  - mkdir /nfs-share/mysql
  - mkdir /nfs-share/wordpress
  - apt update && apt install nfs-kernel-server -y
  - echo -e "/nfs-share 	*(rw,sync,no_root_squash)" >> /etc/exports
  - exportfs -rv
  - chown nobody:nogroup /nfs-share/
  - chmod 777 /nfs-share/
  - systemctl restart nfs-kernel-server   

- name: Get nfs server ip
  command: ip a | grep inet | awk 'FNR == 3 {print $2}' | cut -d '/' -f1
  register: nfsIP

- name: Replace nfs ip in manifest
  replace:
    path: "{{ role_path }}/../../app/wordpress/pv.yaml"
    regexp: '(\b[0-9]{1,3}\.){3}[0-9]{1,3}\b'
    replace: "{{ nfsIP.stdout }}"
  delegate_to: localhost
